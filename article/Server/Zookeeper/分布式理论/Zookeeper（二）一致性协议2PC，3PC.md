---
title: Zookeeper（二）一致性协议2PC，3PC
sidebar_position: 3
keywords:
  - 微服务
  - 源码分析
tags:
  - 源码分析
  - Java
  - 框架
  - 微服务
  - 学习笔记
last_update:
  date: 2024-02-17
  author: EasonShu
---
- 官网：[Apache ZooKeeper](http://zookeeper.apache.org)

## 1.1 2PC协议

- 2PC，是Two-Phase Commit的缩写，即二阶段提交，是计算机网络尤其是在数据库领域内，为了使基于分布式系统架构下的所有节点在进行事务处理过程中能够保持原子性和一致性而设计的一种算法。
- 通常，二阶段提交协议也被认为是一种一致性协议，用来保证分布式系统数据的一致性，目前，绝大部分的关系型数据库都是采用二阶段提交协议来完成分布式事务处理的
- 利用该协议能够非常方便地完成所有分布式事务参与者的协调，统一决定事务的提交或回滚，从而能够有效地保证分布式数据一致性，因此二阶段提交协议被广泛地应用在许多分布式系统中。

### 1.1.1 协议说明

顾名思义，二阶段提交协议是将事务的提交过程分成了两个阶段来进行处理，其执行流程如下。

> 第一阶段：提交事务请求

- 事务询问。协调者向所有的参与者发送事务内容，询问是否可以执行事务提交操作，并开始等待各参与者的响应。
- 执行事务。各参与者节点执行事务操作，并将Undo和Redo信息记入事务日志中。
- 各参与者向协调者反馈事务询问的响应。如果参与者成功执行了事务操作，那么就反馈给协调者Yes响应，表示事务可以执行；如果参与者没有成功执行事务，那么就反馈给协调者No响应，表示事务不可以执行。
- 由于上面讲述的内容在形式上近似是协调者组织各参与者对一次事务操作的投票表态过程，因此二阶段提交协议的阶段一也被称为“投票阶段”，即各参与者投票表明是否要继续执行接下去的事务提交操作。

> 第二阶段：执行事务提交

在阶段二中，协调者会根据各参与者的反馈情况来决定最终是否可以进行事务提交操作，正常情况下，包含以下两种可能。执行事务提交假如协调者从所有的参与者获得的反馈都是Yes响应，那么就会执行事务提交。
![image.png](https://cdn.nlark.com/yuque/0/2024/png/12426173/1710744964850-dd3be679-2005-4f42-ae42-f2bacd398940.png#averageHue=%23f8f8f8&clientId=u41b0586a-6493-4&from=paste&height=432&id=ubcd1335b&originHeight=432&originWidth=1618&originalType=binary&ratio=1&rotation=0&showTitle=false&size=102404&status=done&style=none&taskId=u1a29e105-d070-45df-8ebb-2d100aa89df&title=&width=1618)
**正常事务**

- 发送提交请求。协调者向所有参与者节点发出Commit请求。
- 事务提交。参与者接收到Commit请求后，会正式执行事务提交操作，并在完成提交之后释放在整个事务执行期间占用的事务资源。
- 反馈事务提交结果。参与者在完成事务提交之后，向协调者发送Ack消息。
- 完成事务。协调者接收到所有参与者反馈的Ack消息后，完成事务。

![image.png](https://cdn.nlark.com/yuque/0/2024/png/12426173/1710744948562-c5cd0795-26ae-4e16-9bd1-e22c9c84ffa9.png#averageHue=%23f9f9f9&clientId=u41b0586a-6493-4&from=paste&height=547&id=u7c36da10&originHeight=547&originWidth=1614&originalType=binary&ratio=1&rotation=0&showTitle=false&size=130251&status=done&style=none&taskId=ufb0c57ea-6f79-4939-a4d7-2019745acd7&title=&width=1614)
**中断事务**

- 发送回滚请求。协调者向所有参与者节点发出Rollback请求。
- 事务回滚。参与者接收到Rollback请求后，会利用其在阶段一中记录的Undo信息来执行事务回滚操作，并在完成回滚之后释放在整个事务执行期间占用的资源。
- 反馈事务回滚结果。参与者在完成事务回滚之后，向协调者发送Ack消息。
- 中断事务。协调者接收到所有参与者反馈的Ack消息后，完成事务中断。

### 1.1.2  优缺点

- 优点：原理简单，实现方便。
- 缺点：同步阻塞，单点问题，数据不一致，容错性不好。

#### 同步阻塞

在二阶段提交的过程中，所有的节点都在等待其他节点的响应，无法进行其他操作。这种同步阻塞极大的限制了分布式系统的性能。

#### 单点问题

协调者在整个二阶段提交过程中很重要，如果协调者在提交阶段出现问题，那么整个流程将无法运转。更重要的是，其他参与者将会处于一直锁定事务资源的状态中，而无法继续完成事务操作。

#### 数据不一致

假设当协调者向所有的参与者发送commit请求之后，发生了局部网络异常，或者是协调者在尚未发送完所有 commit请求之前自身发生了崩溃，导致最终只有部分参与者收到了commit请求。这将导致严重的数据不一致问题。

#### 容错性不好

如果在二阶段提交的提交询问阶段中，参与者出现故障，导致协调者始终无法获取到所有参与者的确认信息，这时协调者只能依靠其自身的超时机制，判断是否需要中断事务。显然，这种策略过于保守。换句话说，二阶段提交协议没有设计较为完善的容错机制，任意一个节点是失败都会导致整个事务的失败。

## 1.2 3PC 协议

我们讲解了二阶段提交协议的设计和实现原理，并明确指出了其在实际运行过程中可能存在的诸如同步阻塞、协调者的单点问题、脑裂和太过保守的容错机制等缺陷，因此研究者在二阶段提交协议的基础上进行了改进，提出了三阶段提交协议。

### 1.2.1 协议说明

3PC，是Three-Phase Commit的缩写，即三阶段提交，是2PC的改进版，其将二阶段提交协议的“提交事务请求”过程一分为二，形成了由CanCommit、PreCommit和do Commit三个阶段组成的事务处理协议‘
![image.png](https://cdn.nlark.com/yuque/0/2024/png/12426173/1710745390809-ff218498-1a75-4047-9ac4-de5ae0547cad.png#averageHue=%23fafaf5&clientId=u41b0586a-6493-4&from=paste&height=482&id=uaefcbf77&originHeight=482&originWidth=1576&originalType=binary&ratio=1&rotation=0&showTitle=false&size=226692&status=done&style=none&taskId=u2813720f-3ea9-420c-aefd-59760e3d443&title=&width=1576)

> **第一阶段：CanCommit**

- 事务询问。协调者向所有的参与者发送一个包含事务内容的canCommit请求，询问是否可以执行事务提交操作，并开始等待各参与者的响应。
- 各参与者向协调者反馈事务询问的响应。参与者在接收到来自协调者的canCommit请求后，正常情况下，如果其自身认为可以顺利执行事务，那么会反馈Yes响应，并进入预备状态，否则反馈No响应。

> **第二阶段：PreCommit**

**执行事务预提交**
假如协调者从所有的参与者获得的反馈都是Yes响应，那么就会执行事务预提交。

- 发送预提交请求。协调者向所有参与者节点发出preCommit的请求，并进入Prepared阶段。
- 事务预提交。参与者接收到preCommit请求后，会执行事务操作，并将Undo和Redo信息记录到事务日志中。
- 各参与者向协调者反馈事务执行的响应。如果参与者成功执行了事务操作，那么就会反馈给协调者Ack响应，同时等待最终的指令：提交(commit)或中止(abort)。

**中断事务**
假如任何一个参与者向协调者反馈了No响应，或者在等待超时之后，协调者尚无法接收到所有参与者的反馈响应，那么就会中断事务。

- 发送中断请求。协调者向所有参与者节点发出abort请求。
- 中断事务。无论是收到来自协调者的abort请求，或者是在等待协调者请求过程中出现超时，参与者都会中断事务。

> **第三阶段：doCommit**

**执行提交**

- 发送提交请求。进入这一阶段，假设协调者处于正常工作状态，并且它接收到了来自所有参与者的Ack响应，那么它将从“预提交”状态转换到“提交”状态，并向所有的参与者发送doCommit请求。
- 事务提交。参与者接收到doCommit请求后，会正式执行事务提交操作，并在完成提交之后释放在整个事务执行期间占用的事务资源。
- 反馈事务提交结果。参与者在完成事务提交之后，向协调者发送Ack消息。
- 完成事务。协调者接收到所有参与者反馈的Ack消息后，完成事务。

**中断事务**
进入这一阶段，假设协调者处于正常工作状态，并且有任意一个参与者向协调者反馈了No响应，或者在等待超时之后，协调者尚无法接收到所有参与者的反馈响应，那么就会中断事务。

- 发送中断请求。协调者向所有的参与者节点发送abort请求。
- 事务回滚。参与者接收到abort请求后，会利用其在阶段二中记录的Undo信息来执行事务回滚操作，并在完成回滚之后释放在整个事务执行期间占用的资源。
- 反馈事务回滚结果。参与者在完成事务回滚之后，向协调者发送Ack消息。
- 中断事务。协调者接收到所有参与者反馈的Ack消息后，中断事务。

需要注意的是，一旦进入阶段三，可能会存在以下两种故障。
·协调者出现问题。 协调者和参与者之间的网络出现故障。无论出现哪种情况，最终都会导致参与者无法及时接收到来自协调者的doCommit或是abort请求，针对这样的异常情况，参与者都会在等待超时之后，继续进行事务提交。

### 1.2.2 优缺点

- 三阶段提交协议的优点：相较于二阶段提交协议，三阶段提交协议最大的优点就是降低了参与者的阻塞范围，并且能够在出现单点故障后继续达成一致。
- 三阶段提交协议的缺点：三阶段提交协议在去除阻塞的同时也引入了新的问题，那就是在参与者接收到preCommit消息后，如果网络出现分区，此时协调者所在的节点和参与者无法进行正常的网络通信，在这种情况下，该参与者依然会进行事务的提交，这必然出现数据的不一致性。
